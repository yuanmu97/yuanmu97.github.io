<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Blog - Mu Yuan</title>
    <link rel="stylesheet" href="../stylesheets/styles.css">
    <link rel="stylesheet" href="../stylesheets/blog.css">
    <link rel="icon" href="../imgs/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body class="blog-page">
    <div class="wrapper">
      <header>
        <h1><a href="../index.html">Mu Yuan (袁牧)</a></h1>
        <p><a href="index.html">Blog</a></p>
      </header>
      <section>
        <a href="index.html" class="back-link">← 返回博客列表</a>
        <article id="postArticle">
          <p id="loading">加载中…</p>
          <p id="notFound" class="hidden" style="color:#c0392b;">文章不存在或未发布。</p>
        </article>
      </section>
      <footer>
        <p><small><a href="../index.html">← 返回首页</a></small></p>
      </footer>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="../javascripts/firebase-config.js"></script>
    <script>
      (function() {
        if (typeof FIREBASE_CONFIG === 'undefined' || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') {
          document.getElementById('loading').textContent = '请先配置 Firebase。';
          return;
        }
        firebase.initializeApp(FIREBASE_CONFIG);
        var db = firebase.firestore();

        var params = new URLSearchParams(window.location.search);
        var id = params.get('id');
        var articleEl = document.getElementById('postArticle');
        var loadingEl = document.getElementById('loading');
        var notFoundEl = document.getElementById('notFound');

        if (!id) {
          loadingEl.classList.add('hidden');
          notFoundEl.classList.remove('hidden');
          return;
        }

        db.collection('posts').doc(id).get().then(function(doc) {
          loadingEl.classList.add('hidden');
          if (!doc.exists || !doc.data().published) {
            notFoundEl.classList.remove('hidden');
            return;
          }
          var d = doc.data();
          document.title = (d.title || '无标题') + ' - Mu Yuan Blog';
          var createdAt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : new Date();
          var dateStr = createdAt.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
          var content = d.content || '';
          if (typeof marked !== 'undefined') {
            content = marked.parse(content, { gfm: true });
          } else {
            content = '<pre>' + escapeHtml(content) + '</pre>';
          }
          articleEl.innerHTML = '<h2>' + escapeHtml(d.title || '无标题') + '</h2><p class="post-meta">' + dateStr + '</p><div class="post-content">' + content + '</div>';
        }).catch(function() {
          loadingEl.classList.add('hidden');
          notFoundEl.classList.remove('hidden');
        });

        function escapeHtml(s) {
          var div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }
      })();
    </script>
  </body>
</html>
